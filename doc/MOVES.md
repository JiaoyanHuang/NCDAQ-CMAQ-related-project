MOVES is an emission model developed by US EPA to simulate air pollution emissions in on-road and non-road sectors. Details can be found in MOVES. Here, I listed the steps to handle inputs and outputs of MOVES2014a.
## MOVES installation

The most current MOVES is version 2014b, which can be downloaded from https://www.epa.gov/moves/latest-version-motor-vehicle-emission-simulator-moves, and detail installation can be found in http://www.marama.org/images/stories/documents/MOVES_Installation_Guide.pdf.

### SMOKE-MOVES installation can be 
https://github.com/CEMPD/SMOKE-MOVES and https://github.com/CEMPD/SMOKE-MOVES/wiki/Installing-MOVES2014a-on-Linux, but has not be successfully done at NCDEQ.

## Input data preparation
### Design sheet

A design sheet must to be created as a master files for various tables, an example can be found in 2017_EPA_NEI_Design_Sheet.xlsx.
Project Summary needs to be first QAed and modified as needed.
```
MOVES Specs: QAed and modified as needed.
XML Importer: Column - D, E, F, G, H, M, N
RunSpec: Column - D, E, F, G, H, M, N
FuelSupply: Column – D, F, G, Gaston/Mecklenburg/Wake counties
FuelUsageFractions: Column – D, F, G
FuelForamtion: D, F, G, Gaston/Mecklenburg/Wake counties
AVFT: might be needed some modifications, especially for EV
I/M coverage: check when the regulation change column D, E, F, G, L, M
(for example https://www.ncleg.net/EnactedLegislation/Statutes/PDF/BySection/Chapter_143/GS_143-215.107A.pdf)
sourceTypeAgeDistribution: column – C, H, I
sourceTypeYear: column – C, H, I
zoneMonthHour: column – C, H, I, K
roadTypeDistribution: column – C, D, I, J
avgSpdDIstribution: column – C, D, I, J
CMT Converter: column – D, E, F, L, M
```
### XML Importer
XML Importers are used to import data from tables into MySQL sever. To create these files, a R script (https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/create_XML_2017NEI.R) is used to read a template and modify the data paths/filenames based on design sheet.

### RunSpec
RunSpec files are used to run MOVES simulations and can be generated by a R script (https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/create_RunSpec_2017NEI.R). This script will read a template and modify the data database of cdb and out based on design sheet.

### Vehicle Miles Travel

There several sources of VMT data, including HPMS, TDM, and TRM. In certain cases, not VMT is not generated for full county (only for non-attainment or maintenance areas), therefore, a weight function will be applied to generated full county VMT based on modeled and non-modeled areas. Also, in some cases, VMT is not generated for the specific year that NEI needed, these data will be interpolated to obtain the data for target year.

#### HPMS: annual HPMS data are available for daily average format since 2011 (except 2015), the data are provided by state DOT. 2017 NC VMT By County_NCDOT (002).xlsx

We convert this format into a database format, using sql or R scripts.

Database format - 2017_NC_HPMS_VMT_By_County-AADVMT.xlsx

sql script - https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/create_2016_NC_HPMS_VMT.sql

R script -https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/HPMS_data_reorganizer.R

Run this HPMS to VMT converter xlsm to generate

https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/VMT_convertor_HPMS_2017NEI.xlsm

```
1.      Read design sheet in line 45-47
2.      Obtain the information for VMT (countyID, filename etc) in line 50 -70
3.      TMP file is a temp file to store the data we need, and VMT_HPMS is the template which will be save as corresponding file after all VMT data are correctly changed line 72-76
4.      Loop over each run line 80-131
a.      Obtain necessary info, such as filename year etc line 83-90
b.      Open excel files line 91-93
c.      find the selected county in HPMS input file line 95
d.      select the data we need (usually 12 cells) line 97
e.      select data (VMT number and fleet mix) and paste to VMT file line 102 - 130
f.      save the data as corresponding file name line 132
g.      close all files
```

TDM: state DOT provides us TDM VMT by County files, which include 12 road types.

FullCountyVMT_MRM18v1.1_revised 181130.xlsx

We convert this format into a database format, using sql or R scripts.

Database format - mrm18v1dot1_2045mtp_vmt_speeds_fullcounty_interpolated_2017_databaseformat.xlsx

sql script - https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/create_2016_NC_TDM_VMT.sql

Run this TDM to VMT converter xlsm to generate each file

https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/VMT_convertor_TDM_2017NEI.xlsm
```
1.      Read design sheet in line 47-52
2.      Obtain the information for VMT (countyID, filename etc) in line 55 -75
3.      MRM file is TDM VMT by County file, but the path and filename are too long for windows, I must rename it. TMP file is a temp file to store the data we need, and VMT_TDM is the template which will be save as corresponding file after all VMT data are correctly changed line 80-85
4.      Loop over each run line 88-168
```

```
a.      Obtain necessary info, such as filename year etc line 92-98
b.      Open excel files line 101-103
c.       find the selected county in HPMS input file line 100
d.      select the data we need (usually 12 cells) line 112
e.      select data (VMT number and fleet mix) and paste to VMT file line 117-157
f.        save the data as corresponding file name line 160
g.      close all files
```

### Modeled and Non-modeled areas

### Vehicle population

State DMV provides vehicle report (CR10187_REPORT_CY_2017.txt) which includes 100 counties’ data from 1974. The data are then compelled into VPOP data for MOVES2014 and each county.

M6Vtype9_to_MOVES_sourctypeID_converter.xlsm

This will create VPOP file for each county based on CountyNamesFIPS. In the VBA code, there are some parts needed more attention: newCountyMarker and county name/total.

### Age distribution

State DMV provides vehicle report (CR10187_REPORT_CY_2017.txt) which includes 100 counties’ data from 1974. The data are then compelled into VPOP data for MOVES2014 and each county.

NC_DMV_reg-distrib-converter-veh16-v20180627.xlsm

### Meteorological data

All MET data at airports can be downloaded from https://mesonet.agron.iastate.edu/request/download.phtml?network=NC_ASOS 

https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/MET%20data%20download.R, and these files can be organized by https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/ASOS_data_organizer.R. Another way to obtain raw MET data is through Bradley McLamb.  

To assign MET data to each county, we use https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/RAW_MET_2_REGIONAL_MET.xlsm. This VBA script read data and a MET template (EXAMPLE_MET.xlsx), MET data are assigned to all counties based on NC_Met_Zones_17.xlsx
```
FileNameReg = "NC_Met_Zones_17.xlsx"
FileReg = "V:\Onroad\MOVES_Raw_Data\Met_Data\" & FileNameReg
pathout1 = "V:\Onroad\MOVES_Raw_Data\Met_Data\2017\" & StationID_list(i)
pathin = "V:\Onroad\MOVES_Raw_Data\Met_Data\"
FileNameIn = "McLamb_Bradley_" & StationID_list(i) & "_" & Year & ".xls"
METSheet = "McLamb_Bradley_" & StationID_list(i) & "_" & Year
pathout1 = "V:\Onroad\MOVES_Raw_Data\Met_Data\2017\" & StationID_list(i)
FileNameout = "c" & CountyID(i) & "_y" & Year & "_" & CountyName(i) & "_MET.xlsx"
pathout2 = "V:\Onroad\MOVES_Raw_Data\Met_Data\" & Year
```

### FuelSupply

### FuelUsageFraction

### FuelFormation
We used default MOVES data for fuel in most case.

https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/default_fuel_usage.R

Exact data from movesdb20161117/fuelsupply and fuelformulation
### AVFT
Default AVFT is used.

### IMCoverage
All I&M files are created by https://github.com/JiaoyanHuang/MOVES2014_related_scripts/blob/master/IMfile.R. Originally, I&M files are created by 

IM_Compliance_Factor_Calcs.xlsx  and IMCoverage Years with 20year sliding scale.xlsx
### RoadTypeDistribution
These data are usually included in VMT converter.
### avgSpdDistribution
If HPMS VMT data are used, default avgSpdDistribution from MOVES database will be used. If VMT is calculated from TDM or TRM, specific average speed will be calculated by https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/export_mrm18v1dot1_2045mtp_vmt_speeds_fullcounty_interpolated_2017.sql.

AvgSpeedDist_TrianglePeakPeriods_Mod.xlsm

This VBA script will read, VMT and speed data in the dir you point to (module 1 line 119) to corresponding speed bins.
## Run MOVES

### XML import

V:\Onroad\Projects_Conformity\2018\Triangle_2045_MTP\XML_Importers

FileCheck.bat FileExistCheck.bat FileListXMLCheck.bat

XML_importer_2017_EPANEI.bat

### Run

https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/EXERunSpec_2017EPANEI.R

ExecuteRunSpec_Triangle2045MTP_All.bat

Output data analysis


https://github.com/JiaoyanHuang/NCDAQ-related-projects/tree/master/MOVES2014_related_scripts-master/data_summary.R
